# Correlate distance with motifs #

Loop trough all the files and analyze the results.

First step: loading data
```{r}
setwd("~/Documents/ENS/M1/Stage/para/results/analysis/")
# Load files of genes for each motifs of each species
extract_bi <- dir("../motifs_extraction", full.names=TRUE, pattern="bi.res$")
extract_ca <- dir("../motifs_extraction", full.names=TRUE, pattern="ca.res$")
extract_sex <- dir("../motifs_extraction", full.names=TRUE, pattern="sex.res$")
extract_tet <- dir("../motifs_extraction", full.names=TRUE, pattern="tet.res$")

# Load expression data
exp_bi = read.table("../../data/biaurelia_RNAseq_xp.tab", h=T)
exp_ca = read.table("../../data/caudatum_RNAseq_xp.tab", h=T)
exp_sex = read.table("../../data/sexaurelia_RNAseq_xp.tab", h=T)
exp_tet = read.table("../../data/tetraurelia_RNAseq_xp.tab", h=T)

# Load motifs name <-> motif correspondance table
motifs = read.table("../15may14consensuscomp.txt", sep="\t")
head(motifs)
colnames(motifs) = c("family", "BF.motif", "BF.size", "MEME.motif", "MEME.size", "gene", "match.ratio", "consensus")

# pvalue threshold to select in the whole file
pval.thre = 0.01
```

Function to treat each files from each list
```{r}
# Function to use on every file, returns a table of matching genes between expression and extracted data
corr.dist.exp <- function(extract_file, expression_file) {
  extract_table = read.table(extract_file, h=F)
  colnames(extract_table) = c("gene_id", "distance", "motifs.number")
  extract_match = extract_table[match(expression_file$gene_id, extract_table$gene_id, nomatch=0),]
  extract.merge = merge(extract_match,expression_file)
}

# Function to returns p.value of fitted models
lm.pvalue <- function(table.merged) {
  model = lm(xp~distance, data=table.merged)  # Produce a linear model for data
  p.value = summary(model)$coefficients[[8]]
  rsq = summary(model)$adj.r.squared
  list(p.value, rsq)
}
```

Test on *Paramecium biaurelia*, see the number of significant correlations.

```{r}
bi.pvalues = rep(NA,length(extract_bi))
bi.rsq = rep(NA, length(extract_bi))

for (i in 1:length(extract_bi)) {
  merged = corr.dist.exp(extract_bi[i], exp_bi)

  if (length(merged[,1])>2) {
    mod = lm.pvalue(merged)
    p.value = mod[[1]][1]
    rsq = mod[[2]][1]
    bi.pvalues[i] = p.value
    bi.rsq[i] = rsq
  }
}
length(bi.pvalues)
summary(bi.pvalues)
length(subset(bi.pvalues, bi.pvalues < pval.thre))
```

For *P. caudatum*

```{r}
ca.pvalues = rep(NA,length(extract_ca))
ca.rsq = rep(NA, length(extract_ca))

for (i in 1:length(extract_ca)) {
  merged = corr.dist.exp(extract_ca[i], exp_ca)

  if (length(merged[,1])>2) {
    mod = lm.pvalue(merged)
    p.value = mod[[1]][1]
    rsq = mod[[2]][1]
    ca.pvalues[i] = p.value
    ca.rsq[i] = rsq
  }
}
length(ca.pvalues)
summary(ca.pvalues)
length(subset(ca.pvalues, ca.pvalues < pval.thre))
```

For *P. sexaurelia*

```{r}
sex.pvalues = rep(NA,length(extract_sex))
sex.rsq = rep(NA, length(extract_sex))

for (i in 1:length(extract_sex)) {
  merged = corr.dist.exp(extract_sex[i], exp_sex)

  if (length(merged[,1])>2) {
    mod = lm.pvalue(merged)
    p.value = mod[[1]][1]
    rsq = mod[[2]][1]
    sex.pvalues[i] = p.value
    sex.rsq[i] = rsq
  }
}
length(sex.pvalues)
summary(sex.pvalues)
length(subset(sex.pvalues, sex.pvalues < pval.thre))
```

For *P. tetraurelia*
```{r}
tet.pvalues = rep(NA,length(extract_tet))
tet.rsq = rep(NA, length(extract_tet))

for (i in 1:length(extract_tet)) {
  merged = corr.dist.exp(extract_tet[i], exp_tet)

  if (length(merged[,1])>2) {
    mod = lm.pvalue(merged)
    p.value = mod[[1]][1]
    rsq = mod[[2]][1]
    tet.pvalues[i] = p.value
    tet.rsq[i] = rsq
  }
}
length(tet.pvalues)
summary(tet.pvalues)
length(subset(tet.pvalues, tet.pvalues < pval.thre))
```

Let see if there are some motifs in common.
```{r}

# To have indexes of elements
bi.match = match(subset(bi.pvalues, bi.pvalues < pval.thre), bi.pvalues)
ca.match = match(subset(ca.pvalues, ca.pvalues < pval.thre), ca.pvalues)
sex.match = match(subset(sex.pvalues, sex.pvalues < pval.thre), sex.pvalues)
tet.match = match(subset(tet.pvalues, tet.pvalues < pval.thre), tet.pvalues)

# Common elements
common = intersect(intersect(intersect(bi.match, ca.match), sex.match), tet.match)
length(common)
```

Let's extract the sequence of conserved motifs
```{r}
common.motifs = data.frame()
for (i in 1:length(common)) {
  index = common[i]
  filename = extract_bi[index]
  print(filename)
  filename = strsplit(filename, "/")
  filename = filename[[1]][3]
  fam = substr(filename, 1, 12)
  fam.motif = substr(filename, 13, 18)
  common.motifs = rbind(common.motifs, subset(motifs, family == fam & BF.motif == fam.motif))
}
common.motifs
```
Look at the scatterplots
```{r}
library(ggplot2)
for (i in 1:length(common)) {
  merged = corr.dist.exp(extract_bi[common[i]], exp_bi)
  index = common[i]
  filename = extract_bi[index]
  filename = strsplit(filename, "/")
  filename = filename[[1]][3]
  fam = substr(filename, 1, 12)
  fam.motif = substr(filename, 13, 18)
  mot = subset(common.motifs, family == fam & BF.motif == fam.motif)$consensus
  print(ggplot(merged, aes(x = distance, y = xp)) + geom_point(alpha = 0.5, position = "jitter") + labs(x="Distance from Start Codon", y="Gene Expression", title = paste("Distance - Expression for", mot)))
}
```

If we try to classify motifs as associated with high or low expression among species?
The idea is two try to see if genes with given motif are higher or lower expressed than genes without.

```{r}
# Function to classify motifs as increaser or decreaser of gene expression
expression.modifier <- function(extract_file, exp_file) {
  extract_table = read.table(extract_file, h=F)  # Extract file
  colnames(extract_table) = c("gene_id", "distance", "motifs.number")
  # Expression of genes that contain the motif
  extract_match = exp_file[match(extract_table$gene_id, exp_file$gene_id, nomatch=0),] 
  # Expression of genes without the motif
  extract_no = exp_file[!match(exp_file$gene_id, extract_table$gene_id, nomatch=0),]
  # Compare if the means, null hypothesis: means are equal (better than t-test because non-normal distribution)
  w.test = wilcox.test(extract_match$xp, extract_no$xp)
  if (w.test$p.value < pval.thre) {
    
    # If genes with motif are more expressed, the motif is increasing expression
    if (mean(extract_match$xp > mean(extract_no$xp))) {
      classifier = "high"
    } else {
      classifier = "low"
    }
  }
  else {
    classifier = NA
  }
}
```


```{r}
bi.classify = data.frame()

for (i in 1:length(extract_bi)) {
  filename = extract_bi[i]
  filename = strsplit(filename, "/")
  filename = filename[[1]][3]
  fam = substr(filename, 1, 12)
  fam.motif = substr(filename, 13, 18)
  
  modifier = expression.modifier(extract_bi[i], exp_bi)
  motif_data = subset(motifs, family == fam & BF.motif == fam.motif)
  bi.classify = rbind(bi.classify ,cbind(motif_data, as.factor(modifier)))
  
}
colnames(bi.classify)[9]= "modifier"
```

```{r}
ca.classify = data.frame()

for (i in 1:length(extract_ca)) {
  filename = extract_ca[i]
  filename = strsplit(filename, "/")
  filename = filename[[1]][3]
  fam = substr(filename, 1, 12)
  fam.motif = substr(filename, 13, 18)
  
  modifier = expression.modifier(extract_ca[i], exp_ca)
  motif_data = subset(motifs, family == fam & BF.motif == fam.motif)
  ca.classify = rbind(ca.classify ,cbind(motif_data, as.factor(modifier))
  
}
colnames(ca.classify)[9]= "modifier"
```

```{r}
sex.classify = data.frame()

for (i in 1:length(extract_sex)) {
  filename = extract_sex[i]
  filename = strsplit(filename, "/")
  filename = filename[[1]][3]
  fam = substr(filename, 1, 12)
  fam.motif = substr(filename, 13, 18)
  
  modifier = expression.modifier(extract_sex[i], exp_sex)
  motif_data = subset(motifs, family == fam & BF.motif == fam.motif)
  sex.classify = rbind(sex.classify ,cbind(motif_data, as.factor(modifier)))
  
}
colnames(sex.classify)[9]= "modifier"
```

```{r}
tet.classify = data.frame()

for (i in 1:length(extract_tet)) {
  filename = extract_tet[i]
  filename = strsplit(filename, "/")
  filename = filename[[1]][3]
  fam = substr(filename, 1, 12)
  fam.motif = substr(filename, 13, 18)
  
  modifier = expression.modifier(extract_tet[i], exp_tet)
  motif_data = subset(motifs, family == fam & BF.motif == fam.motif)
  tet.classify = rbind(tet.classify ,cbind(motif_data, as.factor(modifier)))
  
}
colnames(tet.classify)[9]= "modifier"
```

# MEME Motifs #
Let's compare with motifs found by MEME
```{r}
meme.bi = read.table("../motifs_extraction/26may14MEMEMotifs.bi.res")
meme.ca = read.table("../motifs_extraction/26may14MEMEMotifs.ca.res")
meme.sex = read.table("../motifs_extraction/26may14MEMEMotifs.sex.res")
meme.tet = read.table("../motifs_extraction/26may14MEMEMotifs.tet.res")
```